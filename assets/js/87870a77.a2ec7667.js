"use strict";(self.webpackChunkuniversity=self.webpackChunkuniversity||[]).push([[8],{101:(e,r,n)=>{n.d(r,{Ay:()=>i,RM:()=>t});var o=n(4848),s=n(8453);const t=[];function a(e){const r={a:"a",admonition:"admonition",p:"p",...(0,s.R)(),...e.components};return(0,o.jsx)(r.admonition,{title:"Work in progress",type:"warning",children:(0,o.jsxs)(r.p,{children:["We're still working on this part and would love to hear your thoughts! Feel free to ",(0,o.jsx)(r.a,{href:"https://github.com/rossumai/university/discussions",children:"share your feedback"})," or ",(0,o.jsx)(r.a,{href:"https://github.com/rossumai/university/pulls",children:"submit a pull request"}),". Thank you! \ud83d\ude4f"]})})}function i(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(a,{...e})}):a(e)}},9055:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>a,metadata:()=>o,toc:()=>p});const o=JSON.parse('{"id":"learn/export-pipeline/export-evaluator","title":"Export pipelines: Export evaluator","description":"Export evaluator is a piece of a custom code that evaluates the result of API calls and decides whether the export is successful or it has failed.","source":"@site/docs/learn/export-pipeline/export-evaluator.md","sourceDirName":"learn/export-pipeline","slug":"/learn/export-pipeline/export-evaluator","permalink":"/docs/learn/export-pipeline/export-evaluator","draft":false,"unlisted":false,"editUrl":"https://github.com/rossumai/university/tree/master/docs/learn/export-pipeline/export-evaluator.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"title":"Export pipelines: Export evaluator","sidebar_label":"5. Export evaluator","sidebar_position":5},"sidebar":"learnSidebar","previous":{"title":"4. Data value extractor","permalink":"/docs/learn/export-pipeline/data-value-extractor"},"next":{"title":"Supported Integration Patterns","permalink":"/docs/learn/integration-patterns/"}}');var s=n(4848),t=n(8453);n(101);const a={title:"Export pipelines: Export evaluator",sidebar_label:"5. Export evaluator",sidebar_position:5},i="Export evaluator",l={},p=[{value:"Basic export evaluator",id:"basic-export-evaluator",level:2},{value:"Coupa export evaluator",id:"coupa-export-evaluator",level:2}];function d(e){const r={code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"export-evaluator",children:"Export evaluator"})}),"\n",(0,s.jsx)(r.p,{children:"Export evaluator is a piece of a custom code that evaluates the result of API calls and decides whether the export is successful or it has failed."}),"\n",(0,s.jsx)(r.h2,{id:"basic-export-evaluator",children:"Basic export evaluator"}),"\n",(0,s.jsx)(r.p,{children:"The easiest export evaluator simply checks whether the condition is met or not:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-py",children:'from rossum_python import RossumPython\n\ndef rossum_hook_request_handler(payload):\n    r = RossumPython.from_payload(payload)\n\n    if eval(payload.get("settings", {}).get("condition")):\n        r.show_error("Draft invoice not created.")\n\n    return r.hook_response()\n'})}),"\n",(0,s.jsx)(r.p,{children:"Settings example:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",children:'{\n  "condition": "r.field.api1_status_code != \'201\'"\n}\n'})}),"\n",(0,s.jsxs)(r.p,{children:["Note that this example uses ",(0,s.jsx)(r.code,{children:"eval"})," function to evaluate the condition which is considered dangerous if the input is untrusted."]}),"\n",(0,s.jsx)(r.h2,{id:"coupa-export-evaluator",children:"Coupa export evaluator"}),"\n",(0,s.jsx)(r.p,{children:"Coupa REST API typically returns responses in the following format:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",children:'{\n  "errors": {\n    "request": [\n      {\n        "invoice-header": [\n          "Original Invoice Date can\'t be blank",\n          "Original Invoice Number can\'t be blank"\n        ],\n        "invoice-header.invoice_lines": ["Total must be negative, make price/quantity negative"],\n        "invoice-header.invoice_lines.tax_lines": [\n          "Tax Rate should be present on invoices in Italy"\n        ]\n      }\n    ]\n  }\n}\n'})}),"\n",(0,s.jsx)(r.p,{children:"To process such responses, we can use the following evaluator (assuming the API responses and statuses are stored in the appropriate datapoints):"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-py",children:'import json\nfrom rossum_python import RossumPython\n\ndef rossum_hook_request_handler(payload):\n    x = RossumPython.from_payload(payload)\n\n    handle_api_response(x, x.field.api1_status_code, x.field.api1_response_body, "Coupa draft creation", is_error=True)\n    handle_api_response(x, x.field.api2_status_code, x.field.api2_response_body, "Coupa image scan", is_error=True)\n    handle_api_response(x, x.field.api3_status_code, x.field.api3_response_body, "Coupa backlink", is_error=True)\n    handle_api_response(x, x.field.api4_status_code, x.field.api4_response_body, "Coupa submission", is_error=False)\n\n    return x.hook_response()\n\ndef handle_api_response(x, status_code, response_body, message, is_error):\n    if int(status_code) < 400:\n        return\n\n    response_body = try_parse_json(response_body)\n    errors = response_body.get(\'errors\', {}).get(\'request\', [{}])[0] if isinstance(response_body, dict) else None\n\n    if errors:\n        for key, messages in errors.items():\n            for msg in messages:\n                display_msg = f"<b>{message} ({key})</b>: {msg.strip()}"\n                (x.show_error if is_error else x.show_warning)(display_msg)\n    else:\n        (x.show_error if is_error else x.show_warning)(f"<b>{message}</b>: unhandled error")\n\ndef try_parse_json(response_body):\n    try:\n        return json.loads(response_body)\n    except json.JSONDecodeError:\n        return response_body\n'})})]})}function u(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>a,x:()=>i});var o=n(6540);const s={},t=o.createContext(s);function a(e){const r=o.useContext(t);return o.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function i(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),o.createElement(t.Provider,{value:r},e.children)}}}]);